{% extends 'base.html' %}
{% load static %}

{% block title %}ERP Copilot - Assistant Intelligent{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-robot text-primary me-2"></i>ERP Copilot
        </h1>
        <div class="d-flex">
            <button class="btn btn-primary me-2" onclick="runQuickAnalysis()">
                <i class="fas fa-sync-alt me-2"></i>Actualiser l'analyse
            </button>
            <button class="btn btn-success" onclick="generateReport()">
                <i class="fas fa-file-pdf me-2"></i>G√©n√©rer rapport
            </button>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Insights Automatiques
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ copilot_stats.total_insights }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-lightbulb fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Alertes Critiques
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ copilot_stats.critical_alerts }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Opportunit√©s
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ copilot_stats.optimization_opportunities }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Activit√©s R√©centes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ copilot_stats.recent_activities|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Insights Automatiques -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-brain me-2"></i>Insights Automatiques
                    </h6>
                </div>
                <div class="card-body">
                    <div id="insightsContainer">
                        {% for insight in automatic_insights %}
                        <div class="alert alert-{% if insight.type == 'critical' %}danger{% elif insight.type == 'warning' %}warning{% else %}info{% endif %} d-flex align-items-center mb-3">
                            <i class="{{ insight.icon }} me-3 fa-lg"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1">{{ insight.title }}</h6>
                                <p class="mb-1 small">{{ insight.description }}</p>
                            </div>
                            <button class="btn btn-sm btn-outline-{% if insight.type == 'critical' %}danger{% elif insight.type == 'warning' %}warning{% else %}info{% endif %}" 
                                    onclick="handleInsightAction('{{ insight.action }}')">
                                Agir
                            </button>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                            <p>Aucun insight critique d√©tect√©. Tout semble sous contr√¥le !</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Analyse en Temps R√©el -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-chart-bar me-2"></i>Analyse en Temps R√©el
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="btnOverview" onclick="runAnalysis('overview')">
                                Vue Globale
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="btnStock" onclick="runAnalysis('stock')">
                                Stock
                            </button>
                            <button type="button" class="btn btn-outline-info" id="btnProduction" onclick="runAnalysis('production')">
                                Production
                            </button>
                            <button type="button" class="btn btn-outline-success" id="btnFinancial" onclick="runAnalysis('financial')">
                                Finances
                            </button>
                        </div>
                    </div>
                    
                    <div id="analysisResults" class="mt-3">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-2x mb-3"></i>
                            <p>S√©lectionnez un type d'analyse pour commencer</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    </div>
                    
                    <div id="analysisResults" class="mt-3">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-2x mb-3"></i>
                            <p>S√©lectionnez un type d'analyse pour commencer</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Activit√©s R√©centes -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-history me-2"></i>Activit√©s R√©centes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for activity in copilot_stats.recent_activities %}
                        <div class="list-group-item d-flex align-items-center px-0">
                            <div class="flex-shrink-0">
                                <i class="{{ activity.icon }} text-{{ activity.color }} fa-lg"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small class="text-muted">{{ activity.timestamp|date:"d/m/Y H:i" }}</small>
                                <p class="mb-0 small">{{ activity.description }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            <p>Aucune activit√© r√©cente</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

<!-- Actions Rapides CONCR√àTES -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Actions Rapides - R√©sultats Concrets
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Actions imm√©diates :</strong> Ces boutons g√©n√®rent des rapports et actions concrets en temps r√©el.
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100 h-100 py-3" onclick="quickAction('stock_report')">
                            <i class="fas fa-file-alt fa-2x mb-2"></i><br>
                            Rapport Stock<br>
                            <small class="text-muted">Produits √† r√©approvisionner</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-success w-100 h-100 py-3" onclick="quickAction('production_plan')">
                            <i class="fas fa-calendar-check fa-2x mb-2"></i><br>
                            Plan Production<br>
                            <small class="text-muted">Commandes prioritaires</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-info w-100 h-100 py-3" onclick="quickAction('customer_analysis')">
                            <i class="fas fa-chart-pie fa-2x mb-2"></i><br>
                            Analyse Clients<br>
                            <small class="text-muted">Top clients & CA</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-outline-warning w-100 h-100 py-3" onclick="quickAction('alert_summary')">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
                            Synth√®se Alertes<br>
                            <small class="text-muted">Points critiques</small>
                        </button>
                    </div>
                </div>
                
                <!-- R√©sultats des Actions -->
                <div id="actionResults" class="mt-4">
                    <div class="text-center text-muted">
                        <i class="fas fa-rocket fa-2x mb-2"></i>
                        <p>Cliquez sur une action pour voir les r√©sultats concrets</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Suggestions Contextuelles -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-magic me-2"></i>Suggestions Intelligentes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for suggestion in page_suggestions %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-left-primary h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>Suggestion
                                    </h6>
                                    <p class="card-text small">{{ suggestion }}</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="applySuggestion('{{ suggestion }}')">
                                        Appliquer
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mb-0" id="loadingText">Analyse en cours...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ========== GESTIONNAIRE D'√âTAT GLOBAL ==========
const CopilotState = {
    currentAction: null,
    isLoading: false,
    cache: new Map(),
    lastUpdate: null
};

// ========== FONCTIONS CORE OPTIMIS√âES ==========
function getCSRFToken() {
    const cookie = document.cookie.match(/csrftoken=([^;]+)/);
    return cookie ? cookie[1] : null;
}

// Syst√®me de cache intelligent avec expiration (5 minutes)
function getCachedData(key) {
    const cached = CopilotState.cache.get(key);
    if (cached && Date.now() - cached.timestamp < 300000) { // 5 minutes
        return cached.data;
    }
    return null;
}

function setCachedData(key, data) {
    CopilotState.cache.set(key, {
        data: data,
        timestamp: Date.now()
    });
}

// ========== GESTION DU CHARGEMENT OPTIMIS√âE ==========
function showInlineLoading(containerId, text = 'Chargement...') {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="text-muted mb-0">${text}</p>
        </div>
    `;
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
    toast.innerHTML = `
        <strong>${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// ========== REQU√äTES OPTIMIS√âES AVEC CACHE ==========
async function fetchWithCache(url, options = {}, cacheKey = null) {
    const effectiveCacheKey = cacheKey || `${url}_${JSON.stringify(options)}`;
    
    // V√©rifier le cache d'abord
    const cached = getCachedData(effectiveCacheKey);
    if (cached && !options.forceRefresh) {
        return cached;
    }
    
    try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        // Mettre en cache si succ√®s
        if (data.success) {
            setCachedData(effectiveCacheKey, data);
        }
        
        return data;
    } catch (error) {
        console.error('Fetch error:', error);
        
        // Retourner les donn√©es en cache en cas d'erreur
        const cachedData = getCachedData(effectiveCacheKey);
        if (cachedData) {
            showToast('Donn√©es en cache (erreur r√©seau)', 'warning');
            return cachedData;
        }
        
        throw error;
    }
}

// ========== FONCTIONS D'ANALYSE OPTIMIS√âES ==========
async function runAnalysis(analysisType) {
    if (CopilotState.isLoading) return;
    
    console.log(`üöÄ Analyse: ${analysisType}`);
    CopilotState.isLoading = true;
    showInlineLoading('analysisResults', `Analyse ${analysisType} en cours...`);
    
    const formData = new FormData();
    formData.append('analysis_type', analysisType);
    formData.append('csrfmiddlewaretoken', getCSRFToken());

    try {
        const data = await fetchWithCache(
            '{% url "copilot_analyze" %}',
            { method: 'POST', body: formData },
            `analysis_${analysisType}`
        );
        
        displayAnalysisResults(data);
        showToast(`Analyse ${analysisType} termin√©e`);
        
    } catch (error) {
        document.getElementById('analysisResults').innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå Erreur</h5>
                <p>${error.message}</p>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="runAnalysis('${analysisType}')">
                    R√©essayer
                </button>
            </div>
        `;
    } finally {
        CopilotState.isLoading = false;
    }
}

// ========== ACTIONS RAPIDES OPTIMIS√âES ==========
async function quickAction(action) {
    if (CopilotState.isLoading) return;
    
    console.log(`‚ö° Action: ${action}`);
    CopilotState.currentAction = action;
    CopilotState.isLoading = true;
    
    showInlineLoading('actionResults', `Ex√©cution de l'action...`);
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('csrfmiddlewaretoken', getCSRFToken());

    try {
        const startTime = Date.now();
        const data = await fetch('{% url "copilot_execute_action" %}', {
            method: 'POST',
            body: formData
        });
        
        if (!data.ok) throw new Error('Erreur serveur');
        const result = await data.json();
        
        const duration = Date.now() - startTime;
        console.log(`‚úÖ Action ${action} termin√©e en ${duration}ms`);
        
        if (result.success) {
            displayActionResults(result.result);
            showToast('Action ex√©cut√©e avec succ√®s');
        } else {
            throw new Error(result.error || 'Erreur inconnue');
        }
        
    } catch (error) {
        document.getElementById('actionResults').innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå Erreur d'ex√©cution</h5>
                <p>${error.message}</p>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="quickAction('${action}')">
                    R√©essayer
                </button>
            </div>
        `;
    } finally {
        CopilotState.isLoading = false;
        CopilotState.currentAction = null;
    }
}

// ========== AFFICHAGE DES R√âSULTATS OPTIMIS√â ==========
function displayAnalysisResults(data) {
    const container = document.getElementById('analysisResults');
    
    if (!data.success) {
        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }

    const templates = {
        overview: () => `
            <div class="alert alert-primary d-flex align-items-center">
                <i class="fas fa-globe fa-2x me-3"></i>
                <div>
                    <h5 class="mb-1">Vue d'Ensemble Business</h5>
                    <small class="text-muted">${data.timestamp ? new Date(data.timestamp).toLocaleString('fr-FR') : 'Maintenant'}</small>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-left-primary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-2x text-primary mb-2"></i>
                            <h4>${data.data.summary?.total_customers || 0}</h4>
                            <small class="text-muted">Clients</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-success h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-cubes fa-2x text-success mb-2"></i>
                            <h4>${data.data.summary?.total_products || 0}</h4>
                            <small class="text-muted">Produits</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-info h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-tasks fa-2x text-info mb-2"></i>
                            <h4>${data.data.summary?.active_orders || 0}</h4>
                            <small class="text-muted">Commandes Actives</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-left-warning h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                            <h4>${data.data.summary?.monthly_revenue ? Math.round(data.data.summary.monthly_revenue).toLocaleString('fr-FR') + '‚Ç¨' : 'N/A'}</h4>
                            <small class="text-muted">CA Mensuel</small>
                        </div>
                    </div>
                </div>
            </div>
        `,
        
        stock: () => {
            const lowStockCount = data.data.low_stock_count || 0;
            return `
                <div class="alert alert-${lowStockCount > 0 ? 'warning' : 'success'}">
                    <h5><i class="fas fa-boxes me-2"></i>Analyse du Stock</h5>
                    <p class="mb-0"><strong>${lowStockCount} produits n√©cessitent une attention</strong></p>
                </div>
                ${data.data.insights && data.data.insights.length > 0 ? 
                    data.data.insights.map(insight => `
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <span class="small">${insight}</span>
                        </div>
                    `).join('') : 
                    '<div class="alert alert-success">‚úÖ Tous les stocks sont optimaux</div>'
                }
            `;
        },
        
        production: () => {
            const delayedCount = data.data.delayed_orders_count || 0;
            return `
                <div class="alert alert-${delayedCount > 0 ? 'warning' : 'success'}">
                    <h5><i class="fas fa-industry me-2"></i>Analyse Production</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-left-${delayedCount > 0 ? 'danger' : 'success'} h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x text-${delayedCount > 0 ? 'danger' : 'success'} mb-2"></i>
                                <h4>${delayedCount}</h4>
                                <small class="text-muted">Retards</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-left-info h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-play-circle fa-2x text-info mb-2"></i>
                                <h4>${data.data.total_active_orders || 0}</h4>
                                <small class="text-muted">En Production</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-left-warning h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                                <h4>${data.data.urgent_orders_count || 0}</h4>
                                <small class="text-muted">Urgentes</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },
        
        financial: () => `
            <div class="alert alert-success">
                <h5><i class="fas fa-chart-line me-2"></i>Analyse Financi√®re</h5>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card border-left-success h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-success">CA 30 jours</h6>
                                    <h3>${data.data.total_revenue_30d ? data.data.total_revenue_30d.toLocaleString('fr-FR') + '‚Ç¨' : 'N/A'}</h3>
                                </div>
                                <i class="fas fa-euro-sign fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-info h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-info">Commande Moyenne</h6>
                                    <h3>${data.data.average_order_value ? Math.round(data.data.average_order_value).toLocaleString('fr-FR') + '‚Ç¨' : 'N/A'}</h3>
                                </div>
                                <i class="fas fa-shopping-cart fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ${data.data.insights && data.data.insights.length > 0 ? `
                <div class="alert alert-info mt-3">
                    <h6>üìà Insights:</h6>
                    <ul class="mb-0">
                        ${data.data.insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `
    };

    container.innerHTML = templates[data.analysis_type] ? templates[data.analysis_type]() : 
        '<div class="alert alert-danger">Type d\'analyse non support√©</div>';
}

function displayActionResults(result) {
    const container = document.getElementById('actionResults');
    
    const baseHTML = `
        <div class="alert alert-success d-flex align-items-center">
            <i class="fas fa-check-circle fa-2x me-3"></i>
            <div>
                <h5 class="mb-1">${result.message}</h5>
                <small class="text-muted">G√©n√©r√© le ${new Date().toLocaleString('fr-FR')}</small>
            </div>
        </div>
    `;

    const contentTemplates = {
        report: (data) => createReportHTML(data),
        plan: (data) => createPlanHTML(data),
        analysis: (data) => createAnalysisHTML(data),
        alerts: (data) => createAlertsHTML(data),
        action: (data) => createActionHTML(data)
    };

    const content = contentTemplates[result.type] ? contentTemplates[result.type](result.data) : '';
    container.innerHTML = baseHTML + content;
}

// ========== TEMPLATES OPTIMIS√âS ==========
function createReportHTML(data) {
    return `
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card border-left-warning h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h3>${data.low_stock_count || 0}</h3>
                        <small class="text-muted">Stocks Faibles</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-left-danger h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h3>${data.critical_count || 0}</h3>
                        <small class="text-muted">Ruptures</small>
                    </div>
                </div>
            </div>
        </div>
        
        ${data.low_stock_products && data.low_stock_products.length > 0 ? `
            <div class="alert alert-warning">
                <h6><i class="fas fa-list me-2"></i>Produits √† R√©approvisionner</h6>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>R√©f√©rence</th>
                                <th>Produit</th>
                                <th>Stock</th>
                                <th>Minimum</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.low_stock_products.slice(0, 8).map(product => `
                                <tr>
                                    <td><strong>${product.reference}</strong></td>
                                    <td>${product.name}</td>
                                    <td class="${product.current_stock === 0 ? 'text-danger fw-bold' : 'text-warning'}">
                                        ${product.current_stock}
                                    </td>
                                    <td>${product.min_stock}</td>
                                    <td>
                                        <span class="badge bg-${product.current_stock === 0 ? 'danger' : 'warning'}">
                                            ${product.current_stock === 0 ? 'Rupture' : 'Faible'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : '<div class="alert alert-success">‚úÖ Aucun produit en stock faible</div>'}
    `;
}

function createPlanHTML(data) {
    return `
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card border-left-danger h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-danger mb-2"></i>
                        <h3>${data.delayed_orders_count || 0}</h3>
                        <small class="text-muted">Retards</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-left-warning h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                        <h3>${data.urgent_orders_count || 0}</h3>
                        <small class="text-muted">Urgentes</small>
                    </div>
                </div>
            </div>
        </div>
        
        ${data.delayed_orders && data.delayed_orders.length > 0 ? `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-circle me-2"></i>Commandes en Retard</h6>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Commande</th>
                                <th>Client</th>
                                <th>Date Livraison</th>
                                <th>Jours de retard</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.delayed_orders.slice(0, 6).map(order => {
                                const delayDays = Math.floor((new Date() - new Date(order.delivery_date)) / (1000 * 60 * 60 * 24));
                                return `
                                    <tr>
                                        <td><strong>${order.order_number}</strong></td>
                                        <td>${order.customer__name}</td>
                                        <td class="text-danger">${order.delivery_date}</td>
                                        <td><span class="badge bg-danger">${delayDays}j</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : '<div class="alert alert-success">‚úÖ Aucune commande en retard</div>'}
        
        <div class="alert alert-info">
            <h6><i class="fas fa-play-circle me-2"></i>Plan d'Action Imm√©diat</h6>
            <ul class="mb-0 mt-2">
                ${(data.priority_actions || [
                    'Prioriser les commandes en retard',
                    'Allouer des ressources suppl√©mentaires',
                    'Contacter les clients concern√©s',
                    'R√©viser le planning de production'
                ]).map(action => `<li>${action}</li>`).join('')}
            </ul>
        </div>
    `;
}

function createAnalysisHTML(data) {
    return `
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-left-info h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x text-info mb-2"></i>
                        <h4>${data.total_customers || 0}</h4>
                        <small class="text-muted">Clients Total</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-left-success h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-shopping-cart fa-2x text-success mb-2"></i>
                        <h4>${data.recent_orders_count || 0}</h4>
                        <small class="text-muted">Commandes 30j</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-left-warning h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-star fa-2x text-warning mb-2"></i>
                        <h4>${data.top_customers?.length || 0}</h4>
                        <small class="text-muted">Top Clients</small>
                    </div>
                </div>
            </div>
        </div>
        
        ${data.top_customers && data.top_customers.length > 0 ? `
            <div class="alert alert-info">
                <h6><i class="fas fa-trophy me-2"></i>Top 5 Clients</h6>
                <div class="table-responsive mt-2">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Client</th>
                                <th>Commandes</th>
                                <th>Chiffre d'Affaires</th>
                                <th>Moyenne/Commande</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.top_customers.map((customer, index) => {
                                const avgOrder = customer.order_count > 0 ? (customer.total_spent / customer.order_count) : 0;
                                return `
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary me-2">#${index + 1}</span>
                                            ${customer.name}
                                        </td>
                                        <td>${customer.order_count}</td>
                                        <td class="text-success fw-bold">${customer.total_spent ? Math.round(customer.total_spent).toLocaleString('fr-FR') + '‚Ç¨' : '0‚Ç¨'}</td>
                                        <td class="text-info">${avgOrder ? Math.round(avgOrder).toLocaleString('fr-FR') + '‚Ç¨' : 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : ''}
    `;
}

function createAlertsHTML(data) {
    const totalAlerts = (data.low_stock_alerts || 0) + (data.delayed_orders_alerts || 0) + (data.critical_alerts || 0);
    
    return `
        <div class="alert alert-${totalAlerts > 0 ? 'warning' : 'success'}">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Synth√®se des Alertes</h6>
            <p class="mb-2">${totalAlerts} point(s) n√©cessitent votre attention</p>
        </div>
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card border-left-danger h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                        <h3>${data.critical_alerts || 0}</h3>
                        <small class="text-muted">Critiques</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-left-warning h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-circle fa-2x text-warning mb-2"></i>
                        <h3>${data.low_stock_alerts || 0}</h3>
                        <small class="text-muted">Stocks</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-left-info h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h3>${data.delayed_orders_alerts || 0}</h3>
                        <small class="text-muted">Retards</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-light border">
            <h6><i class="fas fa-list-check me-2"></i>Plan d'Action Prioritaire</h6>
            <ul class="mb-0 mt-2">
                ${(data.recommendations || [
                    'Traiter les alertes critiques en premier',
                    'R√©approvisionner les stocks urgents',
                    'Contacter les clients en retard',
                    'R√©viser les processus probl√©matiques'
                ]).map((rec, index) => `
                    <li class="${index < 2 ? 'fw-bold text-danger' : ''}">${rec}</li>
                `).join('')}
            </ul>
        </div>
    `;
}

function createActionHTML(data) {
    return `
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    <h6 class="mb-1">Action Ex√©cut√©e avec Succ√®s</h6>
                    ${data.action ? `<p class="mb-1"><strong>Type:</strong> ${data.action}</p>` : ''}
                    ${data.product_reference ? `<p class="mb-1"><strong>Produit:</strong> ${data.product_reference}</p>` : ''}
                    ${data.affected_orders ? `<p class="mb-1"><strong>Commandes affect√©es:</strong> ${data.affected_orders}</p>` : ''}
                    <small class="text-muted">Statut: ${data.status || 'termin√©'}</small>
                </div>
            </div>
        </div>
    `;
}

// ========== FONCTIONS UTILITAIRES RAPIDES ==========
function handleInsightAction(action) {
    quickAction(action);
}

function runQuickAnalysis() {
    showInlineLoading('analysisResults', 'Actualisation des donn√©es...');
    setTimeout(() => {
        // Recharger les donn√©es sans recharger toute la page
        CopilotState.cache.clear();
        runAnalysis('overview');
        showToast('Donn√©es actualis√©es avec succ√®s');
    }, 500);
}

function generateReport() {
    showToast('G√©n√©ration du rapport PDF en cours...', 'info');
    // Simulation de g√©n√©ration PDF
    setTimeout(() => {
        showToast('Rapport PDF g√©n√©r√© avec succ√®s');
    }, 2000);
}

function applySuggestion(suggestion) {
    showToast(`Suggestion appliqu√©e: ${suggestion}`, 'info');
}

// ========== INITIALISATION OPTIMIS√âE ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ ERP Copilot Ultra-Optimis√© - Pr√™t !');
    
    // Configuration des √©couteurs d'√©v√©nements optimis√©e
    const analysisButtons = {
        'btnOverview': 'overview',
        'btnStock': 'stock', 
        'btnProduction': 'production',
        'btnFinancial': 'financial'
    };
    
    Object.entries(analysisButtons).forEach(([id, type]) => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('click', () => runAnalysis(type));
        }
    });
    
    // √âcouteurs pour les actions insights
    document.querySelectorAll('[onclick*="handleInsightAction"]').forEach(button => {
        const match = button.getAttribute('onclick').match(/handleInsightAction\('([^']+)'\)/);
        if (match) {
            button.addEventListener('click', () => handleInsightAction(match[1]));
        }
    });
    
    // Auto-refresh toutes les 2 minutes (optionnel)
    setInterval(() => {
        if (!CopilotState.isLoading && document.visibilityState === 'visible') {
            CopilotState.cache.clear();
            console.log('üîÑ Cache nettoy√© - pr√™t pour nouvelles donn√©es');
        }
    }, 120000);
    
    console.log('‚úÖ Interface ultra-optimis√©e initialis√©e');
});
</script>
{% endblock %}
